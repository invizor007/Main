<html>
<head><title>Sudoku</title></head>
<link rel="stylesheet" href="bootstrap-3.3.2-dist/css/bootstrap.min.css">
<script language="javascript">
var aMain = [
[[0],[0],[8],[0],[4],[6],[0],[3],[0]],
[[0],[0],[4],[0],[0],[1],[0],[0],[2]],
[[0],[0],[0],[0],[0],[2],[6],[5],[0]],

[[8],[0],[0],[0],[0],[0],[0],[7],[0]],
[[5],[0],[0],[2],[0],[3],[0],[0],[8]],
[[0],[7],[0],[0],[0],[0],[0],[0],[9]],

[[0],[6],[7],[4],[0],[0],[0],[0],[0]],
[[2],[0],[0],[6],[0],[0],[4],[0],[0]],
[[0],[8],[0],[3],[9],[0],[2],[0],[0]]
];


var aPlaceNXY = Array(9);
var currxnum = -1, currynum = -1, currval = -1;
var vismode = -1;
var strsrc = "640009503|000500090|000400001|100308720|005020900|028607005|200006000|080005000|907800052";

function constr_aPlaceNXY()
{
	for (var i=0;i<9;i++)
	{
		aPlaceNXY[i] = Array(9);
		for (var j=0;j<9;j++)
			aPlaceNXY[i][j] = Array(9);
	}		
}

function init_aMain_null()
{
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
			aMain[i][j]=0;
	return;
}

//640009503|000500090|000400001|100308720|005020900|028607005|200006000|080005000|907800052
function init_aMain_fromstr(s)
{
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)			
		{
			var num = i*10+j; //alert(s[num]);
			aMain[i][j] = parseInt(s[num],10);
		}
	return;
}

function init_aPlaceNXY()
{//расположение одного числа
	if (vismode<0) return;
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
			for (var k=0;k<9;k++)
				aPlaceNXY[i][j][k] = 1;
	
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
		{
			if (aMain[i][j]>0)
			{
				var tmpval = aMain[i][j]-1;
				var i1 = Math.floor(i/3), i2 = i % 3;
				var j1 = Math.floor(j/3), j2 = j % 3;
				var sqnum = i1*3+j1;
				for (var k=0;k<3;k++)
					for (var l=0;l<3;l++)
						aPlaceNXY[tmpval][i1*3+k][j1*3+l]=0;
				for (var k=0;k<9;k++)
					aPlaceNXY[tmpval][k][j] = 0;
				for (var k=0;k<9;k++)
					aPlaceNXY[tmpval][i][k] = 0;
					
				for (var k=0;k<9;k++)
					aPlaceNXY[k][i][j] = 0;
				
				aPlaceNXY[tmpval][i][j] = 1;
			}
		}
}

function Out_Info()
{
	var strtmp = "";
	for (var i=0;i<9;i++) 
	{
		strtmp = (i+1)+":  ";
		for (var j=0;j<9;j++) 
		{		
			for (var k=0;k<9;k++)
				strtmp += aPlaceNXY[i][j][k];
			strtmp += '|';
		}
		alert(strtmp);
	}
}

function Load_Canvas()
{
	var ctx = document.getElementById("canvas1").getContext("2d");
	ctx.fillStyle = 'white';
	ctx.strokeStyle = 'white';
	ctx.fillRect(0,0,359,359);
	
	ctx.fillStyle = 'black';
	ctx.strokeStyle = 'black';
	ctx.font = '14px serif';
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
			if (aMain[i][j]>0)
			{
				ctx.strokeRect(40*i,40*j,40,40);
				ctx.fillText(aMain[i][j]+"",40*i+20,40*j+20);
			}
			

	ctx.fillStyle = 'black';
	ctx.strokeStyle = 'black';
	ctx.font = '8px serif';
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
			if (aMain[i][j]==0)
			{
				ctx.strokeRect(40*i,40*j,40,40);
				if (vismode == 1)
					for (var k=0;k<9;k++)
						if (aPlaceNXY[k][i][j]==1)
						{
							var tmp = k+1, addx = 10+8*Math.floor(k/3), addy = 15+8*(k%3);
							ctx.fillText(tmp+"",40*i+addx,40*j+addy);
						}
			}			
	
	ctx.fillStyle = 'navi';
	ctx.strokeStyle = 'navi';
	for (var i=0;i<3;i++)
		for (var j=0;j<3;j++)
			ctx.strokeRect(120*i+1,120*j+1,120-2,120-2);
}

function Check_Solo()
{
	var solocheck = 0;
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
			if (aMain[i][j]==0)
			{
				for (var k=0;k<9;k++) if (aPlaceNXY[k][i][j] == 1)
				{				
					solocheck = 1;
					for (var l=0;l<9;l++)
						if ((l!=i)&&(aMain[l][j]==0))
							if (aPlaceNXY[k][l][j]==1)
								solocheck = 0;						
					if (solocheck==1) return [k+1,i,j,1];
						
					solocheck = 1;
					for (var l=0;l<9;l++)
						if ((l!=j)&&(aMain[i][l]==0))
							if (aPlaceNXY[k][i][l]==1)
								solocheck = 0;
					if (solocheck==1) return [k+1,i,j,2];
					
					solocheck = 1;
					for (var l=3*Math.floor(i/3);l<3*Math.floor(i/3)+3;l++)
						for (var m=3*Math.floor(j/3);m<3*Math.floor(j/3)+3;m++)
							if ((l!=i || m!=j)&&(aMain[l][m]==0))
								if (aPlaceNXY[k][l][m]==1)
									solocheck = 0;
					if (solocheck==1) return [k+1,i,j,3];
				}
			}
	return [-1,-1,-1,-1];
}

function Check_Finish()
{
	for (var i=0;i<9;i++)
		for (var j=0;j<9;j++)
		{
			if (aMain[i][j]==0) return;
		}
	vismode = -2;
}

function Click_Canvas(e)
{
	if (vismode==-1) return;
	Load_Canvas();
	var ctx = document.getElementById("canvas1").getContext("2d");
	if (!e) e = window.event; //alert(event.pageX);alert(event.pageY);
	currxnum = Math.floor(event.pageX / 40);
	currynum = Math.floor(event.pageY / 40);
	
	ctx.fillStyle = 'green';
	ctx.strokeStyle = 'green';	
	currval = aMain[currxnum][currynum];
	if ((currval>=1)&&(currval<=9))
		for (var i=0;i<9;i++)
			for (var j=0;j<9;j++)
				if (aMain[i][j] +" " == currval+" ")
					ctx.strokeRect(40*i+2,40*j+2,40-4,40-4);

	ctx.fillStyle = 'red';
	ctx.strokeStyle = 'red';	
	ctx.strokeRect(40*currxnum+2,40*currynum+2,40-4,40-4);
}

function Keypress_Canvas(e)
{
	if ((currxnum == -1)||(currynum == -1)||(vismode<0)) return;
	var currnum = 0;
	var pressedkey = e.key;
	if ((pressedkey >= '0') && (pressedkey <= '9'))
	{
		currnum = parseInt(pressedkey,10);
		aMain[currxnum][currynum] = currnum;
		Load_Canvas();
	}
	Check_Finish();
}

function Click_StepAI()
{
	if (vismode<0) return;
	var addplace = Check_Solo(); 
	console.log(addplace[0]*1000+addplace[1]*100+addplace[2]*10+addplace[3]);
	if (addplace[0]!=-1)
	{
		aMain[addplace[1]][addplace[2]] = addplace[0];
		init_aPlaceNXY();
		Load_Canvas();
		Check_Finish();
	}
}

function Click_Start()
{
	vismode = 0;
	//init_aMain_fromstr(strsrc);
	init_aPlaceNXY();
	//Out_Info();
	Load_Canvas();
}

function Click_Submatrix()
{
	if (vismode>=0)
	{
		vismode = vismode==0?1:0;
		Load_Canvas();
	}
}
</script>

<body onkeypress=Keypress_Canvas(event) onload=constr_aPlaceNXY()>

<div id="main" >
<canvas id="canvas1" width="360" height="360" onclick=Click_Canvas(event) onkeypress=Keypress_Canvas(event)>
</canvas>
</div>
<br>
<input type="button" class="btn" value="Старт" onclick=Click_Start()>
<input type="button" class="btn" value="Доступные числа" onclick=Click_Submatrix()>
<input type="button" class="btn" value="Ход ИИ" onclick=Click_StepAI()>

</body>

</html>
